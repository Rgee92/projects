---

AWSTemplateFormatVersion: '2010-09-09'

Description: Create all Resources to have CloudTrail run in a Given Account

Mappings: {}

Resources:

  # an S3 bucket is needed for writing CloudTrail events
  CloudTrailS3Bucket:
    Type: AWS::S3::Bucket

  CloudTrailTrail:
    Type: AWS::CloudTrail::Trail
    Properties:
      # EnableLogFileValidation
      EnableLogFileValidation: false
      # IncludeGlobalServiceEvents
      # Does CloudTrail include events generated by calls to global services
      # such as IAM?
      IncludeGlobalServiceEvents: true
      IsLogging: true
      # if IsMultiRegionTrail is true
      # then IncludeGlobalServiceEvents: true
      IsMultiRegionTrail: true
      S3BucketName: !Ref CloudTrailS3Bucket

  # An S3 S3 Bucket Policy is required that allows the AWS CloudTrail service
  # to write to the S3 Bucket
  CloudTrailS3BucketBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties: 
      Bucket: !Ref CloudTrailS3Bucket
      PolicyDocument: 
        Version: 2012-10-17
        Statement: 
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal: 
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !Sub "arn:aws:s3:::${CloudTrailS3Bucket}"
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal: 
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub "arn:aws:s3:::${CloudTrailS3Bucket}/AWSLogs/${AWS::AccountId}/*"
            Condition: 
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control

Outputs: {}
