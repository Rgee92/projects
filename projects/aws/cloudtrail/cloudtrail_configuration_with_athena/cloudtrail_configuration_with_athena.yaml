---

AWSTemplateFormatVersion: '2010-09-09'

Description: Create all Resources to have CloudTrail run in a Given Account

Mappings: {}

Resources:

  # an S3 bucket is needed for writing CloudTrail events
  CloudTrailS3Bucket:
    Type: AWS::S3::Bucket

  CloudTrailTrail:
    # DependsOn: CloudTrailS3BucketBucketPolicy is utilized to avoid the following error
    # Incorrect S3 bucket policy is detected for bucket: ${CloudTrailS3Bucket}
    DependsOn: CloudTrailS3BucketBucketPolicy
    Type: AWS::CloudTrail::Trail
    Properties:
      # EnableLogFileValidation
      EnableLogFileValidation: false
      # IncludeGlobalServiceEvents
      # Does CloudTrail include events generated by calls to global services
      # such as IAM?
      IncludeGlobalServiceEvents: true
      IsLogging: true
      # if IsMultiRegionTrail is true
      # then IncludeGlobalServiceEvents: true
      IsMultiRegionTrail: true
      S3BucketName: !Ref CloudTrailS3Bucket

  # An S3 S3 Bucket Policy is required that allows the AWS CloudTrail service
  # to write to the S3 Bucket
  CloudTrailS3BucketBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties: 
      Bucket: !Ref CloudTrailS3Bucket
      PolicyDocument: 
        Version: 2012-10-17
        Statement: 
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal: 
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !Sub arn:aws:s3:::${CloudTrailS3Bucket}
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal: 
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub arn:aws:s3:::${CloudTrailS3Bucket}/AWSLogs/${AWS::AccountId}/*
            Condition: 
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control

  CloudTrailGlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput: {}

  CloudTrailGlueTable:
  # taken from https://github.com/bamcis-io/AWS-CloudFormation-Scripts/blob/9e5853cfb2ad0f5e63380cd96a202b0ead67a955/CloudFormationScripts/Athena/cloudtrail-logs.template
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref CloudTrailGlueDatabase
      TableInput:
        TableType: EXTERNAL_TABLE
        Parameters:
          classification: cloudtrail
          exclusions:
            Fn::Sub: '["${CloudTrailS3Bucket}**/CloudTrail-Digest/**"]'
          compressionType: gzip
          typeOfData: file
        StorageDescriptor:
          InputFormat: com.amazon.emr.cloudtrail.CloudTrailInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            Name: CloudTrail SerDe
            SerializationLibrary: com.amazon.emr.hive.serde.CloudTrailSerde
            Parameters: {}
          Parameters:
            classification: cloudtrail
          Location: !Ref CloudTrailS3Bucket
          StoredAsSubDirectories: true
          Compressed: true
          Columns:
          - Name: eventVersion
            Type: string
          - Name: userIdentity
            Type:
              Fn::Join:
              - ''
              - - struct<
                - type:string,
                - principalId:string,
                - arn:string,
                - accountId:string,
                - invokedBy:string,
                - accessKeyId:string,
                - userName:string,
                - sessionContext:struct<
                - attributes:struct<
                - mfaAuthenticated:string,
                - creationDate:string>,
                - sessionIssuer:struct<
                - type:string,
                - principalId:string,
                - arn:string,
                - accountId:string,
                - userName:string>>>
          - Name: eventTime
            Type: string
          - Name: eventSource
            Type: string
          - Name: eventName
            Type: string
          - Name: awsRegion
            Type: string
          - Name: sourceIpAddress
            Type: string
          - Name: userAgent
            Type: string
          - Name: errorCode
            Type: string
          - Name: errorMessage
            Type: string
          - Name: requestParameters
            Type: string
          - Name: responseElements
            Type: string
          - Name: additionalEventData
            Type: string
          - Name: requestId
            Type: string
          - Name: eventId
            Type: string
          - Name: resources
            Type:
              Fn::Join:
              - ''
              - - array<
                - struct<
                - arn:string,
                - accountId:string,
                - type:string
                - ">>"
          - Name: eventType
            Type: string
          - Name: apiVersion
            Type: string
          - Name: readOnly
            Type: string
          - Name: recipientAccountId
            Type: string
          - Name: serviceEventDetails
            Type: string
          - Name: sharedEventID
            Type: string
          - Name: vpcEndpointId
            Type: string        

Outputs: {}
