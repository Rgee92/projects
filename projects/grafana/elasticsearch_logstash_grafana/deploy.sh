#!/bin/bash

# install java and keyfile
# required for both elasticsearch and logstash
apt -y install default-jre
wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -


# install elasticsearch
echo "deb https://packages.elastic.co/elasticsearch/2.x/debian stable main" | sudo tee -a /etc/apt/sources.list.d/elasticsearch-2.x.list
apt -y update
apt -y install elasticsearch
# if needed: confirm status of elasticsearch
# systemctl status elasticsearch
systemctl start elasticsearch

# install logstash
echo "deb https://packages.elastic.co/logstash/2.3/debian stable main" | sudo tee -a /etc/apt/sources.list
apt -y update
apt -y install logstash
# configure logstash
cat > /etc/logstash/conf.d/system_logs <<EOF
input {
  file {
    path => [ "/var/log/auth.log", "/var/log/syslog" ]
  }
}
output {
  elasticsearch {
    document_type => "system_logs"
    hosts => "http://127.0.0.1:9200"
    index => "elg"
  }
}
EOF
# do not run usermod -a -G adm logstash on production system without
# evaluation of impact of change
usermod -a -G adm logstash
systemctl start logstash


# install grafana
cat > /etc/apt/sources.list.d/packagecloud.io.list <<EOF
deb https://packagecloud.io/grafana/stable/debian/ wheezy main
EOF
curl https://packagecloud.io/gpg.key | sudo apt-key add -
apt -y update
apt -y install grafana
systemctl start grafana-server

apt -y install sqlite3
cd /var/lib/grafana/
# add data source
sqlite3 grafana.db "INSERT INTO \"data_source\" VALUES(1,1,0,'elasticsearch','elasticsearch','proxy','http://localhost:9200','','','elg',0,'','',0,X'7B2274696D654669656C64223A224074696D657374616D70227D','2016-08-13 05:15:14','2016-08-13 05:16:45',0);"
# insert graphs
sqlite3 grafana.db "INSERT INTO \"dashboard\" VALUES(1,1,'elg','elg',X'7B22616E6E6F746174696F6E73223A7B226C697374223A5B5D7D2C226564697461626C65223A747275652C22676E65744964223A6E756C6C2C2268696465436F6E74726F6C73223A66616C73652C226964223A312C226C696E6B73223A5B5D2C22726F7773223A5B7B22636F6C6C61707365223A66616C73652C226564697461626C65223A747275652C22686569676874223A223235307078222C2270616E656C73223A5B7B22616C696173436F6C6F7273223A7B7D2C2262617273223A66616C73652C2264617461736F75726365223A22656C6173746963736561726368222C226564697461626C65223A747275652C226572726F72223A66616C73652C2266696C6C223A312C2267726964223A7B227468726573686F6C6431223A6E756C6C2C227468726573686F6C6431436F6C6F72223A2272676261283231362C203230302C2032372C20302E323729222C227468726573686F6C6432223A6E756C6C2C227468726573686F6C6432436F6C6F72223A2272676261283233342C203131322C203131322C20302E323229227D2C226964223A312C2269734E6577223A747275652C226C6567656E64223A7B22617667223A66616C73652C2263757272656E74223A66616C73652C226D6178223A66616C73652C226D696E223A66616C73652C2273686F77223A747275652C22746F74616C223A66616C73652C2276616C756573223A66616C73657D2C226C696E6573223A747275652C226C696E657769647468223A322C226C696E6B73223A5B5D2C226E756C6C506F696E744D6F6465223A22636F6E6E6563746564222C2270657263656E74616765223A66616C73652C22706F696E74726164697573223A352C22706F696E7473223A66616C73652C2272656E6465726572223A22666C6F74222C227365726965734F7665727269646573223A5B5D2C227370616E223A31322C22737461636B223A66616C73652C22737465707065644C696E65223A66616C73652C2274617267657473223A5B7B226275636B657441676773223A5B7B226669656C64223A224074696D657374616D70222C226964223A2232222C2273657474696E6773223A7B22696E74657276616C223A226175746F222C226D696E5F646F635F636F756E74223A302C227472696D4564676573223A307D2C2274797065223A22646174655F686973746F6772616D227D5D2C22647354797065223A22656C6173746963736561726368222C226D657472696373223A5B7B226669656C64223A2273656C656374206669656C64222C226964223A2231222C2274797065223A22636F756E74227D5D2C227175657279223A22706174683D5C222F7661722F6C6F672F7379736C6F675C22222C227265664964223A2241222C2274696D654669656C64223A224074696D657374616D70227D5D2C2274696D6546726F6D223A6E756C6C2C2274696D655368696674223A6E756C6C2C227469746C65223A222F7661722F6C6F672F7379736C6F67222C22746F6F6C746970223A7B226D735265736F6C7574696F6E223A747275652C22736861726564223A747275652C22736F7274223A302C2276616C75655F74797065223A2263756D756C6174697665227D2C2274797065223A226772617068222C227861786973223A7B2273686F77223A747275657D2C227961786573223A5B7B22666F726D6174223A2273686F7274222C226C6162656C223A6E756C6C2C226C6F6742617365223A312C226D6178223A6E756C6C2C226D696E223A6E756C6C2C2273686F77223A747275657D2C7B22666F726D6174223A2273686F7274222C226C6162656C223A6E756C6C2C226C6F6742617365223A312C226D6178223A6E756C6C2C226D696E223A6E756C6C2C2273686F77223A747275657D5D7D5D2C2273686F775469746C65223A66616C73652C227469746C65223A22526F77227D2C7B22636F6C6C61707365223A66616C73652C226564697461626C65223A747275652C22686569676874223A223330307078222C2270616E656C73223A5B7B22636F6C756D6E73223A5B7B2274657874223A226D657373616765222C2276616C7565223A226D657373616765227D5D2C2264617461736F75726365223A22656C6173746963736561726368222C226564697461626C65223A747275652C226572726F72223A66616C73652C22666F6E7453697A65223A2231303025222C226964223A322C2269734E6577223A747275652C226C696E6B73223A5B5D2C227061676553697A65223A6E756C6C2C227363726F6C6C223A747275652C2273686F77486561646572223A747275652C22736F7274223A7B22636F6C223A6E756C6C2C2264657363223A66616C73657D2C227370616E223A31322C227374796C6573223A5B7B2264617465466F726D6174223A22595959592D4D4D2D44442048483A6D6D3A7373222C227061747465726E223A2254696D65222C2274797065223A2264617465227D2C7B22636F6C6F724D6F6465223A6E756C6C2C22636F6C6F7273223A5B2272676261283234352C2035342C2035342C20302E3929222C2272676261283233372C203132392C2034302C20302E383929222C22726762612835302C203137322C2034352C20302E393729225D2C22646563696D616C73223A322C227061747465726E223A222F2E2A2F222C227468726573686F6C6473223A5B5D2C2274797065223A226E756D626572222C22756E6974223A2273686F7274227D5D2C2274617267657473223A5B7B226275636B657441676773223A5B5D2C22647354797065223A22656C6173746963736561726368222C226D657472696373223A5B7B226669656C64223A2273656C656374206669656C64222C226964223A2231222C226D657461223A7B7D2C2273657474696E6773223A7B7D2C2274797065223A227261775F646F63756D656E74227D5D2C227175657279223A22706174683D5C222F7661722F6C6F672F7379736C6F675C22222C227265664964223A2241222C2274696D654669656C64223A224074696D657374616D70227D5D2C227469746C65223A222F7661722F6C6F672F7379736C6F67222C227472616E73666F726D223A226A736F6E222C2274797065223A227461626C65227D5D2C227469746C65223A224E657720726F77227D5D2C22736368656D6156657273696F6E223A31322C2273686172656443726F737368616972223A66616C73652C227374796C65223A226461726B222C2274616773223A5B5D2C2274656D706C6174696E67223A7B226C697374223A5B5D7D2C2274696D65223A7B2266726F6D223A226E6F772D356D222C22746F223A226E6F77227D2C2274696D657069636B6572223A7B22726566726573685F696E74657276616C73223A5B223573222C22313073222C22333073222C22316D222C22356D222C2231356D222C2233306D222C223168222C223268222C223164225D2C2274696D655F6F7074696F6E73223A5B22356D222C2231356D222C223168222C223668222C22313268222C22323468222C223264222C223764222C22333064225D7D2C2274696D657A6F6E65223A2262726F77736572222C227469746C65223A22656C67222C2276657273696F6E223A317D',1,'2016-08-13 05:34:24','2016-08-13 05:47:59',1,1,0,'');"


